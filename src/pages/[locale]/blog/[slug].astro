---
import Layout from '../../../layouts/Layout.astro';
import { locales, isValidLocale, getLocalizedPath, formatDate, type Locale } from '../../../utils/i18n';
import { getEntry, getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => {
    const [locale, ...slugParts] = post.slug.split('/');
    const slug = slugParts.join('/');
    return {
      params: { locale, slug },
      props: { post },
    };
  });
}

const { locale, slug } = Astro.params;
const { post } = Astro.props;

if (!isValidLocale(locale)) {
  return Astro.redirect('/en/blog');
}

const entry = await getEntry('pages', locale as Locale);
const t = entry.data;

const { Content } = await render(post);

const categoryColors: Record<string, string> = {
  ai: 'bg-blue-100 text-blue-700',
  documentation: 'bg-green-100 text-green-700',
  practice: 'bg-orange-100 text-orange-700',
};
---

<Layout title={post.data.title} description={post.data.excerpt}>
  <article class="pt-32 pb-20 bg-white">
    <div class="max-w-5xl mx-auto px-6 sm:px-8 lg:px-12">
      <a
        href={getLocalizedPath('/blog', locale as Locale)}
        class="inline-flex items-center gap-2 text-primary-600 hover:text-primary-700 mb-8"
      >
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        {t.blog.backToBlog}
      </a>

      <header class="mb-12">
        {post.data.category !== 'news' && categoryColors[post.data.category] && (
          <span class={`inline-block px-3 py-1 rounded-full text-sm font-medium mb-6 ${categoryColors[post.data.category]}`}>
            {t.blog.categories[post.data.category as keyof typeof t.blog.categories]}
          </span>
        )}
        <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold text-gray-900 mb-8 leading-tight">
          {post.data.title}
        </h1>
        <div class="flex items-center gap-4 text-sm text-gray-500 pt-4 border-t border-gray-200">
          <span>{formatDate(post.data.date, locale as Locale)}</span>
        </div>
      </header>

      <div id="photo-gallery" class="flex gap-4 mb-10">
        <div class="gallery-item relative rounded-xl overflow-hidden shadow-lg">
          <img
            src={post.data.image}
            alt={post.data.title}
            class="gallery-img"
          />
        </div>
      </div>

      <div class="blog-content max-w-none">
        <Content />
      </div>

    </div>
  </article>
</Layout>

<style>
  :global(.gallery-item) {
    flex: 1;
    min-width: 0;
  }

  :global(.gallery-img) {
    width: 100%;
    height: 320px;
    object-fit: cover;
  }

  .blog-content :global(img) {
    display: none;
  }

  .blog-content {
    font-family: 'Open Sans', system-ui, sans-serif;
    font-size: 1.125rem;
    line-height: 1.85;
    color: #374151;
  }

  .blog-content :global(p) {
    font-size: 1.125rem;
    line-height: 1.85;
    margin-bottom: 1.5rem;
    color: #374151;
  }

  .blog-content :global(h2) {
    font-size: 1.75rem;
    font-weight: 700;
    color: #111827;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    line-height: 1.3;
  }

  .blog-content :global(h3) {
    font-size: 1.375rem;
    font-weight: 700;
    color: #111827;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    line-height: 1.4;
  }

  .blog-content :global(strong) {
    font-weight: 600;
    color: #111827;
  }

  .blog-content :global(ul) {
    list-style-type: disc;
    padding-left: 1.5rem;
    margin: 1.25rem 0;
    color: #374151;
  }

  .blog-content :global(li) {
    margin-bottom: 0.5rem;
    font-size: 1.125rem;
    line-height: 1.75;
  }

  .blog-content :global(a) {
    color: #7951fb;
    text-decoration: underline;
    text-underline-offset: 3px;
    transition: color 0.2s;
  }

  .blog-content :global(a:hover) {
    color: #5a34d4;
  }

  .blog-content :global(hr) {
    border: none;
    border-top: 1px solid #e5e7eb;
    margin: 1.5rem 0;
  }

  .blog-content :global(blockquote) {
    border-left: 4px solid #7951fb;
    padding-left: 1.5rem;
    font-style: italic;
    color: #4b5563;
    margin: 1.5rem 0;
  }
</style>

<script>
  const gallery = document.getElementById('photo-gallery');
  const content = document.querySelector('.blog-content');
  if (gallery && content) {
    const imgs = content.querySelectorAll('img');
    imgs.forEach((img) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'gallery-item relative rounded-xl overflow-hidden shadow-lg';
      const clone = img.cloneNode(true) as HTMLImageElement;
      clone.className = 'gallery-img';
      clone.style.display = 'block';
      wrapper.appendChild(clone);
      gallery.appendChild(wrapper);
      const parent = img.parentElement;
      if (parent && parent.tagName === 'P' && parent.children.length === 1) {
        parent.remove();
      } else {
        img.remove();
      }
    });
  }

</script>
